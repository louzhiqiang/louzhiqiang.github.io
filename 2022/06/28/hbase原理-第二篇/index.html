<!DOCTYPE HTML>
<html lang="zh-Hans">


<head>
    <meta charset="utf-8">
    <meta name="keywords" content="hbase原理 第二篇, 痒痒 团团 和 咘咘">
    <meta name="description" content="hbase的gchbase的gc优化的主要原则就是减少fullgc，优化目标主要是Memstore 和 blockcache。
针对 Memstore 主要是Thread-Local Allocation Buffer和MemStore C">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <meta name="renderer" content="webkit|ie-stand|ie-comp">
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="format-detection" content="telephone=no">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="referrer" content="no-referrer-when-downgrade">
    <!-- Global site tag (gtag.js) - Google Analytics -->


    <title>hbase原理 第二篇 | 痒痒 团团 和 咘咘</title>
    <link rel="icon" type="image/png" href="/favicon.png">
    


    <!-- bg-cover style     -->



<link rel="stylesheet" type="text/css" href="/libs/awesome/css/all.min.css">
<link rel="stylesheet" type="text/css" href="/libs/materialize/materialize.min.css">
<link rel="stylesheet" type="text/css" href="/libs/aos/aos.css">
<link rel="stylesheet" type="text/css" href="/libs/animate/animate.min.css">
<link rel="stylesheet" type="text/css" href="/libs/lightGallery/css/lightgallery.min.css">
<link rel="stylesheet" type="text/css" href="/css/matery.css">
<link rel="stylesheet" type="text/css" href="/css/my.css">
<link rel="stylesheet" type="text/css" href="/css/dark.css" media="none" onload="if(media!='all')media='all'">




    <link rel="stylesheet" href="/libs/tocbot/tocbot.css">
    <link rel="stylesheet" href="/css/post.css">




    
        <link rel="stylesheet" type="text/css" href="/css/reward.css">
    



    <script src="/libs/jquery/jquery-3.6.0.min.js"></script>

<meta name="generator" content="Hexo 4.2.1"><link rel="alternate" href="/atom.xml" title="痒痒 团团 和 咘咘" type="application/atom+xml">
</head>


<body>
    <header class="navbar-fixed">
    <nav id="headNav" class="bg-color nav-transparent">
        <div id="navContainer" class="nav-wrapper container">
            <div class="brand-logo">
                <a href="/" class="waves-effect waves-light">
                    
                    <img src="/medias/logo.png" class="logo-img" alt="LOGO">
                    
                    <span class="logo-span">痒痒 团团 和 咘咘</span>
                </a>
            </div>
            

<a href="#" data-target="mobile-nav" class="sidenav-trigger button-collapse"><i class="fas fa-bars"></i></a>
<ul class="right nav-menu">
  
  <li class="hide-on-med-and-down nav-item">
    
    <a href="/" class="waves-effect waves-light">
      
      <i class="fas fa-home" style="zoom: 0.6;"></i>
      
      <span>Index</span>
    </a>
    
  </li>
  
  <li class="hide-on-med-and-down nav-item">
    
    <a href="/tags" class="waves-effect waves-light">
      
      <i class="fas fa-tags" style="zoom: 0.6;"></i>
      
      <span>Tags</span>
    </a>
    
  </li>
  
  <li class="hide-on-med-and-down nav-item">
    
    <a href="/categories" class="waves-effect waves-light">
      
      <i class="fas fa-bookmark" style="zoom: 0.6;"></i>
      
      <span>Categories</span>
    </a>
    
  </li>
  
  <li class="hide-on-med-and-down nav-item">
    
    <a href="/archives" class="waves-effect waves-light">
      
      <i class="fas fa-archive" style="zoom: 0.6;"></i>
      
      <span>Archives</span>
    </a>
    
  </li>
  
  <li class="hide-on-med-and-down nav-item">
    
    <a href="/about" class="waves-effect waves-light">
      
      <i class="fas fa-user-circle" style="zoom: 0.6;"></i>
      
      <span>About</span>
    </a>
    
  </li>
  
  <li class="hide-on-med-and-down nav-item">
    
    <a href="/contact" class="waves-effect waves-light">
      
      <i class="fas fa-comments" style="zoom: 0.6;"></i>
      
      <span>Contact</span>
    </a>
    
  </li>
  
  <li class="hide-on-med-and-down nav-item">
    
    <a href="/friends" class="waves-effect waves-light">
      
      <i class="fas fa-address-book" style="zoom: 0.6;"></i>
      
      <span>Friends</span>
    </a>
    
  </li>
  
  <li>
    <a href="#searchModal" class="modal-trigger waves-effect waves-light">
      <i id="searchIcon" class="fas fa-search" title="Search" style="zoom: 0.85;"></i>
    </a>
  </li>
  <li>
    <a href="javascript:;" class="waves-effect waves-light" onclick="switchNightMode()" title="深色/浅色模式" >
      <i id="sum-moon-icon" class="fas fa-sun" style="zoom: 0.85;"></i>
    </a>
  </li>
</ul>


<div id="mobile-nav" class="side-nav sidenav">

    <div class="mobile-head bg-color">
        
        <img src="/medias/logo.png" class="logo-img circle responsive-img">
        
        <div class="logo-name">痒痒 团团 和 咘咘</div>
        <div class="logo-desc">
            
            从自律开始
            
        </div>
    </div>

    <ul class="menu-list mobile-menu-list">
        
        <li class="m-nav-item">
	  
		<a href="/" class="waves-effect waves-light">
			
			    <i class="fa-fw fas fa-home"></i>
			
			Index
		</a>
          
        </li>
        
        <li class="m-nav-item">
	  
		<a href="/tags" class="waves-effect waves-light">
			
			    <i class="fa-fw fas fa-tags"></i>
			
			Tags
		</a>
          
        </li>
        
        <li class="m-nav-item">
	  
		<a href="/categories" class="waves-effect waves-light">
			
			    <i class="fa-fw fas fa-bookmark"></i>
			
			Categories
		</a>
          
        </li>
        
        <li class="m-nav-item">
	  
		<a href="/archives" class="waves-effect waves-light">
			
			    <i class="fa-fw fas fa-archive"></i>
			
			Archives
		</a>
          
        </li>
        
        <li class="m-nav-item">
	  
		<a href="/about" class="waves-effect waves-light">
			
			    <i class="fa-fw fas fa-user-circle"></i>
			
			About
		</a>
          
        </li>
        
        <li class="m-nav-item">
	  
		<a href="/contact" class="waves-effect waves-light">
			
			    <i class="fa-fw fas fa-comments"></i>
			
			Contact
		</a>
          
        </li>
        
        <li class="m-nav-item">
	  
		<a href="/friends" class="waves-effect waves-light">
			
			    <i class="fa-fw fas fa-address-book"></i>
			
			Friends
		</a>
          
        </li>
        
        
        <li><div class="divider"></div></li>
        <li>
            <a href="https://github.com/blinkfox/hexo-theme-matery" class="waves-effect waves-light" target="_blank">
                <i class="fab fa-github-square fa-fw"></i>Fork Me
            </a>
        </li>
        
    </ul>
</div>


        </div>

        
            <style>
    .nav-transparent .github-corner {
        display: none !important;
    }

    .github-corner {
        position: absolute;
        z-index: 10;
        top: 0;
        right: 0;
        border: 0;
        transform: scale(1.1);
    }

    .github-corner svg {
        color: #0f9d58;
        fill: #fff;
        height: 64px;
        width: 64px;
    }

    .github-corner:hover .octo-arm {
        animation: a 0.56s ease-in-out;
    }

    .github-corner .octo-arm {
        animation: none;
    }

    @keyframes a {
        0%,
        to {
            transform: rotate(0);
        }
        20%,
        60% {
            transform: rotate(-25deg);
        }
        40%,
        80% {
            transform: rotate(10deg);
        }
    }
</style>

<a href="https://github.com/blinkfox/hexo-theme-matery" class="github-corner tooltipped hide-on-med-and-down" target="_blank"
   data-tooltip="Fork Me" data-position="left" data-delay="50">
    <svg viewBox="0 0 250 250" aria-hidden="true">
        <path d="M0,0 L115,115 L130,115 L142,142 L250,250 L250,0 Z"></path>
        <path d="M128.3,109.0 C113.8,99.7 119.0,89.6 119.0,89.6 C122.0,82.7 120.5,78.6 120.5,78.6 C119.2,72.0 123.4,76.3 123.4,76.3 C127.3,80.9 125.5,87.3 125.5,87.3 C122.9,97.6 130.6,101.9 134.4,103.2"
              fill="currentColor" style="transform-origin: 130px 106px;" class="octo-arm"></path>
        <path d="M115.0,115.0 C114.9,115.1 118.7,116.5 119.8,115.4 L133.7,101.6 C136.9,99.2 139.9,98.4 142.2,98.6 C133.8,88.0 127.5,74.4 143.8,58.0 C148.5,53.4 154.0,51.2 159.7,51.0 C160.3,49.4 163.2,43.6 171.4,40.1 C171.4,40.1 176.1,42.5 178.8,56.2 C183.1,58.6 187.2,61.8 190.9,65.4 C194.5,69.0 197.7,73.2 200.1,77.6 C213.8,80.2 216.3,84.9 216.3,84.9 C212.7,93.1 206.9,96.0 205.4,96.6 C205.1,102.4 203.0,107.8 198.3,112.5 C181.9,128.9 168.3,122.5 157.7,114.1 C157.9,116.9 156.7,120.9 152.7,124.9 L141.0,136.5 C139.8,137.7 141.6,141.9 141.8,141.8 Z"
              fill="currentColor" class="octo-body"></path>
    </svg>
</a>
        
    </nav>

</header>

    



<div class="bg-cover pd-header post-cover" style="background-image: url('/medias/featureimages/9.jpg')">
    <div class="container" style="right: 0px;left: 0px;">
        <div class="row">
            <div class="col s12 m12 l12">
                <div class="brand">
                    <h1 class="description center-align post-title">hbase原理 第二篇</h1>
                </div>
            </div>
        </div>
    </div>
</div>




<main class="post-container content">

    
    <div class="row">
    <div id="main-content" class="col s12 m12 l9">
        <!-- 文章内容详情 -->
<div id="artDetail">
    <div class="card">
        <div class="card-content article-info">
            <div class="row tag-cate">
                <div class="col s7">
                    
                    <div class="article-tag">
                        
                            <a href="/tags/hbase/">
                                <span class="chip bg-color">hbase</span>
                            </a>
                        
                    </div>
                    
                </div>
                <div class="col s5 right-align">
                    
                    <div class="post-cate">
                        <i class="fas fa-bookmark fa-fw icon-category"></i>
                        
                            <a href="/categories/%E5%A4%A7%E6%95%B0%E6%8D%AE/" class="post-category">
                                大数据
                            </a>
                        
                    </div>
                    
                </div>
            </div>

            <div class="post-info">
                
                <div class="post-date info-break-policy">
                    <i class="far fa-calendar-minus fa-fw"></i>Publish Date:&nbsp;&nbsp;
                    2022-06-28
                </div>
                

                

                

                

                
            </div>
        </div>
        <hr class="clearfix">

        

        

        <div class="card-content article-card-content">
            <div id="articleContent">
                <h1 id="hbase的gc"><a href="#hbase的gc" class="headerlink" title="hbase的gc"></a>hbase的gc</h1><p>hbase的gc优化的主要原则就是减少fullgc，优化目标主要是Memstore 和 blockcache。</p>
<p>针对 Memstore 主要是Thread-Local Allocation Buffer和MemStore Chunk Pool ， 针对blockcache 主要是 BucketCache 方案。</p>
<blockquote>
<p>full gc 的触发主要是老年代的垃圾回收方式 cms 算法。根据标记算法，会回收掉未标记的数据，但是没有重新压缩分配空间，这样就产生了大量的碎片空间。而再有新的s1的数据过来的时候，或者有个大对象直接过来的时候，就会产生fullgc。这个产生时机很重要，所有的优化也都是围绕着这个点来进行，就是减少这个点的触发时机，也就减少fullgc。</p>
</blockquote>
<p>上边的优化方案主要是通过内存管理来进行的，也就是设置内存池的方式，预先分配，然后使用完的内存块会回收利用。</p>
<p>blockcache的思路是减少堆内对象的使用，直接使用堆外内存。</p>
<blockquote>
<p>这两个思路都是比较常见的优化思路。</p>
</blockquote>
<blockquote>
<p>关于lrucache 和 bucket cache的区别，前者是堆内，后者是堆外，但是在不用的场景，两者的效率是不一样的，cache命中率更高的场景，lru效率更佳，而后者虽然减少了堆内存的问题，但是在返回数据的时候需要一次copy，导致在cache命中率很好的情况下，效率是在下降的。</p>
<p>在命中率一半的情况下，推荐 bucket。</p>
</blockquote>
<p>新生代使用并行标记整理清除算法(<strong>Parallel New Collector</strong>)，老年代使用cms(<strong>Concurrent Mark-Sweep</strong>)收集算法。</p>
<p>参考：</p>
<p><a href="http://hbasefly.com/2016/05/21/hbase-gc-1/" target="_blank" rel="noopener">HBase GC的前生今世 &#8211; 身世篇 &#8211; 有态度的HBase/Spark/BigData</a></p>
<p><a href="http://hbasefly.com/2016/05/29/hbase-gc-2/" target="_blank" rel="noopener">HBase GC的前生今世 &#8211; 演进篇 &#8211; 有态度的HBase/Spark/BigData</a></p>
<h1 id="CMS-GC调优"><a href="#CMS-GC调优" class="headerlink" title="CMS GC调优"></a>CMS GC调优</h1><p> GC 调优的最终目标和基本原则：</p>
<ol>
<li><p>平均 Minor GC 时间尽可能短。因为整个 Minor GC 都处于 STW，因此短时间 Minor GC 会使用户读写更加平稳，延迟可控。</p>
</li>
<li><p>CMS GC 次数越少越好。时间越短越好。一方面是因为一次 CMS GC 一般都会引起至少秒级的应用暂停，对用户读写影响较大；另一方面频繁的 CMS GC 会产生大量的内存碎片，严重的时候会引起 Full GC，导致 RegionServer 宕机。</p>
</li>
</ol>
<h3 id="阶段一：默认推荐配置"><a href="#阶段一：默认推荐配置" class="headerlink" title="阶段一：默认推荐配置"></a>阶段一：默认推荐配置</h3><p><img src="http://hbasefly.com/wp-content/uploads/2016/08/20160809211013_37305.png" alt=""></p>
<p>对性能影响重大的参数：Xmn、SurvivorRatio 以及 MaxTenuringThreshold。</p>
<p>需要注意只有在添加参数 - XX:+PrintTenuringDistribution 才能打印对应日志，<strong>强烈建议线上集群开启该参数</strong>，他会记录各个区的大小，以及各个年龄段的分布。</p>
<h3 id="阶段二：NewParSize-调优"><a href="#阶段二：NewParSize-调优" class="headerlink" title="阶段二：NewParSize 调优"></a><strong>阶段二：NewParSize 调优</strong></h3><p>NewParSize 表示 young 区大小，而 young 区大小直接决定 minor gc 的频率。</p>
<ol>
<li><p>增大 young 区大小，minor gc 频率降低，单次 gc 时间会较长（young 区设置更大，一次 gc 就需要复制更多对象，耗时必然比较长），业务读写操作延迟抖动较大。反之，业务读写操作延迟抖动较小，比较平稳。</p>
</li>
<li><p>减小 young 区大小，minor gc 频率增快，但会加快晋升到老年代的对象总量（每 gc 一次，对象 age 就会加一，当 age 超过阈值就会晋升到老年代，因此 gc 频率越高，age 就增加越快），潜在增加 old gc 风险。</p>
</li>
</ol>
<p>Xmn 设置过小会导致 CMS GC 性能较差，而设置过大会导致 Minor GC 性能较差，因此建议在 JVM Heap 为 64g 以上的情况下设置 Xmn 在 1～3g 之间，在 32g 之下设置为 512m～1g；具体最好经过简单的线上调试；需要特别强调的是，笔者在很多场合都看到很多 HBase 线上集群会把 Xmn 设置的很大，比如有些集群 Xmx 为 48g，Xmn 为 10g，查看日志发现 GC 性能极差：单次 Minor GC 基本都在 300ms～500ms 之间，CMS GC 更是很多超过 1s。在此强烈建议，将 Xmn 调大对 GC（无论 Minor GC 还是 CMS GC）没有任何好处，不要设置太大。</p>
<h3 id="阶段三：增大-Survivor-区大小（减小-SurvivorRatio）-amp-增大-MaxTenuringThreshold"><a href="#阶段三：增大-Survivor-区大小（减小-SurvivorRatio）-amp-增大-MaxTenuringThreshold" class="headerlink" title="阶段三：增大 Survivor 区大小（减小 SurvivorRatio） &amp; 增大 MaxTenuringThreshold"></a><strong>阶段三：增大 Survivor 区大小（减小 SurvivorRatio） &amp; 增大 MaxTenuringThreshold</strong></h3><p>一次 Minor GC 会将存活对象从 Eden 区（以及 survivor from 区）复制到 Survivor 区（to 区），因此增大 Survivor 区可以容纳更多的存活对象。这样就会防止因为 Survivor 区太小导致很对存活对象还没有达到 MaxTenuringThreshold 阈值就直接进入老生代，潜在增大 old gc 的触发频率；但是 Survivor 区设置太大也会有一定的问题，Survivor 设置较大会使得对象可以在 Young 区’待’的时间很长，但是对于一些长寿对象较多的场景下（比如 HBase），大量长寿对象长时间待在 Young 区做很多’无谓’的复制，一定程度上增加 Minor GC 开销。</p>
<p>另外，增加 MaxTenuringThreshold 相当于提高了进入老年代的门槛，可以有效限制进入老年代的对象数。和 Survivor 设置相似，调整 MaxTenuringThreshold 也需要做一个取舍，设置太小会增加 CMS GC 的触发频率以及耗时，而设置太大则会在长寿对象较多场景下增加 Minor GC 开销。一般情况下，默认 MaxTenuringThreshold=15 已经相对比较大，不需要做任何调整。</p>
<h2 id="CMS-调优结论"><a href="#CMS-调优结论" class="headerlink" title="CMS 调优结论"></a><strong>CMS 调优结论</strong></h2><ol>
<li><p>缓存模式采用 BucketCache 策略 Offheap 模式</p>
</li>
<li><p>对于大内存（大于 64G），采用如下配置：</p>
</li>
</ol>
<p>-Xmx64g -Xms64g -Xmn2g -Xss256k -XX:MaxPermSize=256m -XX:SurvivorRatio=2  -XX:+UseConcMarkSweepGC -XX:+UseParNewGC<br>-XX:+CMSParallelRemarkEnabled -XX:MaxTenuringThreshold=15 -XX:+UseCMSCompactAtFullCollection  -XX:+UseCMSInitiatingOccupancyOnly<br>-XX:CMSInitiatingOccupancyFraction=75 -XX:-DisableExplicitGC</p>
<p>其中 Xmn 可以随着 Java 分配堆内存增大而适度增大，但是不能大于 4g，取值范围在 1~3g 范围；SurvivorRatio 一般建议选择为 2；MaxTenuringThreshold 设置为 15；</p>
<ol start="3">
<li>对于小内存（小于 64G），只需要将上述配置中 Xmn 改为 512m-1g 即可</li>
</ol>
<p>参考：</p>
<p><a href="http://hbasefly.com/2016/08/09/hbase-cms-gc/" target="_blank" rel="noopener">HBase最佳实践－CMS GC调优 &#8211; 有态度的HBase/Spark/BigData</a></p>
<h1 id="客户端重试机制"><a href="#客户端重试机制" class="headerlink" title="客户端重试机制"></a>客户端重试机制</h1><p>hbase在查询的时候，需要元数据，然后元数据是缓存在内存中的。但是元数据只加载一次，所以为了应对并发，有一个锁，来方式并发的加载。</p>
<p>但是当出现网络抖动等异常的时候，可能会造成锁等待。</p>
<p>为了应对这种偶尔的网络抖动导致的异常，hbase的客户端，支持使用重试机制来屏蔽这样的问题，但是每次重试都是有时间间隔的，用来规避网络抖动。按照默认配置，最长可能会间隔20S，按照默认31次的重试机制，可能需要总共时间448S的延迟。而这段时间内，客户端会一直持有这把锁。</p>
<p>为了避免这种情况，可以选择改小这个参数，改小重试次数。</p>
<p>参考：</p>
<p><a href="http://hbasefly.com/2016/06/04/hbase-client-1/" target="_blank" rel="noopener">HBase最佳实践 &#8211; 客户端重试机制 &#8211; 有态度的HBase/Spark/BigData</a></p>
<h1 id="客户端超时机制"><a href="#客户端超时机制" class="headerlink" title="客户端超时机制"></a>客户端超时机制</h1><p>hbase针对复杂的客户端访问策略，设置了很多的超时策略参数。</p>
<p><strong>hbase.rpc.timeout</strong> 表示一次rpc请求的超时时间。</p>
<p><strong>hbase.client.operation.timeout</strong> 表示一次操作的时间。一次操作是可能包含多个rpc请求的。这个操作不包含scan操作。</p>
<p><strong>hbase.client.scanner.timeout.period</strong> HBase 会将一次大的 scan 操作根据设置条件拆分为多个 RPC 请求，每次只返回规定数量的结果。参数 hbase.client.scanner.timeout.period 就用来表示这么一次 RPC 请求的超时时间，默认为 60000ms，一旦请求超时，就会抛出 SocketTimeoutException 异常。</p>
<p>一次完整的 scan 通常会被拆分为多个 RPC 请求，实际实现中，RegionServer 接收到第一次 RPC 请求之后，会为该 scan 操作生成一个全局唯一的 id，称为 scanId。除此之外，RegionServer 还会进行大量的准备工作，构建整个 scan 体系，构造需要用到的所有对象，后续的 RPC 请求只需要携带相同的 scanId 作为标示就可以直接利用这些已经构建好的资源进行检索。也就是说，在整个 scan 过程中，客户端其实都占用着服务器端的资源，此时如果此客户端意外宕机，是否就意味着这些资源永远都不能得到释放呢？租约机制就是为了解决这个问题。RegionServer 接收到第一次 RPC 之后，除了生成全局唯一的 scanId 之外还会生成一个携带有超时时间的 lease，超时时间可以通过参数 <strong>hbase.regionserver.lease.period</strong> 配置，一旦在超时时间内后续 RPC 请求没有到来（比如客户端处理太慢），RegionServer 就认为客户端出现异常，此时会将该 lease 销毁并将整个 scan 所持有的资源全部释放，客户端在处理完成之后再发后续的 RPC 过来，检查到对应的 lease 已经不存在，就会抛出 leaseExcption。</p>
<p>参考：</p>
<p><a href="http://hbasefly.com/2016/06/11/hbase-client-2/" target="_blank" rel="noopener">HBase最佳实践－客户端超时机制 &#8211; 有态度的HBase/Spark/BigData</a></p>
<h1 id="列族设计优化"><a href="#列族设计优化" class="headerlink" title="列族设计优化"></a>列族设计优化</h1><h2 id="BLOCKSIZE-设置"><a href="#BLOCKSIZE-设置" class="headerlink" title="BLOCKSIZE 设置"></a>BLOCKSIZE 设置</h2><p>用户平均读取数据的大小。理论上讲，如果用户平均读取数据的大小较小，建议将块大小设置较小，这样可以使得内存可以缓存更多 block，读性能自然会更好。相反，建议将块大小设置较大。</p>
<p>随着 BlockSize 增大，scan 的吞吐量逐渐增大，延迟不断降低。</p>
<p>如果业务请求以 Get 请求为主，可以考虑将块大小设置较小；如果以 Scan 请求为主，可以将块大小调大；默认的 64K 块大小是在 Scan 和 Get 之间取得的一个平衡。</p>
<h2 id="COMPRESSION设置"><a href="#COMPRESSION设置" class="headerlink" title="COMPRESSION设置"></a>COMPRESSION设置</h2><p><img src="http://hbasefly.com/wp-content/uploads/2016/07/3.png" alt=""></p>
<p>压缩和编码是在flush阶段进行的。所以压缩和编码是对flush有影响，对于写没有影响。</p>
<p>读取阶段需要先解压，然后再decode。所以编码对于大部分读取都有影响，而解压操作，只在缓存未命中的情况下有影响。</p>
<p><img src="http://hbasefly.com/wp-content/uploads/2016/07/5.png" alt=""></p>
<p>Snappy 的压缩率最低，但是编解码速率最高，对 CPU 的消耗也最小，目前一般建议使用 Snappy。</p>
<h2 id="Encode-Decode"><a href="#Encode-Decode" class="headerlink" title="Encode/Decode"></a>Encode/Decode</h2><p>HBase 目前提供了四种常用的编码方式：Prefix | Diff | Fast_Diff | Prefix_Tree。</p>
<p><img src="http://hbasefly.com/wp-content/uploads/2016/07/6.png" alt=""></p>
<p>prefix_tree 压缩算法在不同的 block size 下性能都比较稳定，而另外两种压缩算法的查找性能会随着 blocksize 直线下降。对于我们默认的 64K 的 block 大小，性能相差 40 + 倍。</p>
<p>prefix_tree 针对数据完全有序的情况下，可以组织数据按照前缀树的方式进行存储，然后查询的时候按照需要加载到内存里，对于hbase场景里的大部分操作效果都更加突出的。</p>
<p>而且在叶子节点上，数据也是有序存储的。基于 prefix_tree 编码的datablock也是按照这棵树的结构进行存储的。</p>
<p>参考：</p>
<p><a href="http://hbasefly.com/2016/07/02/hbase-pracise-cfsetting/" target="_blank" rel="noopener">HBase最佳实践－列族设计优化 &#8211; 有态度的HBase/Spark/BigData</a></p>
<p><a href="https://www.iteye.com/blog/zjushch-1843793" target="_blank" rel="noopener">https://www.iteye.com/blog/zjushch-1843793</a></p>
<h1 id="COMPACTION"><a href="#COMPACTION" class="headerlink" title="COMPACTION"></a>COMPACTION</h1><p>选择合适的文件进行合并是整个 compaction 的核心。</p>
<p>因为合并文件的大小以及其当前承载的 IO 数直接决定了 compaction 的效果。最理想的情况是，这些文件承载了大量 IO 请求但是大小很小，这样 compaction 本身不会消耗太多 IO，而且合并完成之后对读的性能会有显著提升。</p>
<p>选择合并文件的策略基本就是先排除不合并的，然后选择可以合并的。在可以合并的这些里，选出最高效的集合。</p>
<p>HBase 实现中有一个专门的线程 CompactSplitThead 负责接收 compact 请求以及 split 请求，而且为了能够独立处理这些请求，这个线程内部构造了多个线程池：largeCompactions、smallCompactions 以及 splits 等，其中 splits 线程池负责处理所有的 split 请求，largeCompactions 和 smallCompaction 负责处理所有的 compaction 请求，其中前者用来处理大规模 compaction，后者处理小规模 compaction。</p>
<p>待 compact 的文件总大小如果大于值 throttlePoint（可以通过参数 hbase.regionserver.thread.compaction.throttle 配置，默认为 2.5G），分配给 largeCompactions 处理，否则分配给 smallCompactions 处理。</p>
<h2 id="执行-HFile-文件合并"><a href="#执行-HFile-文件合并" class="headerlink" title="执行 HFile 文件合并"></a>执行 HFile 文件合并</h2><ol>
<li><p>分别读出待合并 hfile 文件的 KV，并顺序写到位于./tmp 目录下的临时文件中</p>
</li>
<li><p>将临时文件移动到对应 region 的数据目录</p>
</li>
<li><p>将 compaction 的输入文件路径和输出文件路径封装为 KV 写入 WAL 日志，并打上 compaction 标记，最后强制执行 sync</p>
</li>
<li><p>将对应 region 数据目录下的 compaction 输入文件全部删除</p>
</li>
</ol>
<p>上述四个步骤看起来简单，但实际是很严谨的，具有很强的容错性和完美的幂等性：</p>
<ol>
<li><p>如果 RS 在步骤 2 之前发生异常，本次 compaction 会被认为失败，如果继续进行同样的 compaction，上次异常对接下来的 compaction 不会有任何影响，也不会对读写有任何影响。唯一的影响就是多了一份多余的数据。</p>
</li>
<li><p>如果 RS 在步骤 2 之后、步骤 3 之前发生异常，同样的，仅仅会多一份冗余数据。</p>
</li>
<li><p>如果在步骤 3 之后、步骤 4 之前发生异常，RS 在重新打开 region 之后首先会从 WAL 中看到标有 compaction 的日志，因为此时输入文件和输出文件已经持久化到 HDFS，因此只需要根据 WAL 移除掉 compaction 输入文件即可</p>
</li>
</ol>
<h2 id="COMPACT策略"><a href="#COMPACT策略" class="headerlink" title="COMPACT策略"></a>COMPACT策略</h2><p>compact的主要痛点是会写放大，随着放大程度，IO消耗会越来越可观，对于系统的影响会越来越明显，也就造成数据的实际使用会有更多不稳定的因素在里边。</p>
<p>compaction 到底选择什么样的策略需要根据不同的业务场景、不同数据集特征进行确定。</p>
<p>compact优化的共性特征：</p>
<ul>
<li><p>减少参与 compaction 的文件数：这个很好理解，实现起来却比较麻烦，首先需要将文件根据 rowkey、version 或其他属性进行分割，再根据这些属性挑选部分重要的文件参与合并；另一方面，尽量不要合并那些大文件，减少参与合并的文件数。</p>
</li>
<li><p>不要合并那些不需要合并的文件：比如老数据就没必要合并</p>
</li>
<li><p>小 region 更有利于 compaction：小 region 只会生成少量文件，这些文件合并不会引起很大的 IO 放大</p>
</li>
</ul>
<h3 id="FIFO-Compaction"><a href="#FIFO-Compaction" class="headerlink" title="FIFO Compaction"></a>FIFO Compaction</h3><p>FIFO Compaction 策略主要参考了 <a href="https://github.com/facebook/rocksdb/wiki/FIFO-compaction-style">rocksdb 的实现</a>，它会选择那些过期的数据文件，即该文件内所有数据都已经过期。因此，对应业务的列族必须设置 TTL，否则肯定不适合该策略。需要注意的是，该策略只做这么一件事情：收集所有已经过期的文件并删除。</p>
<h3 id="Tier-Based-Compaction"><a href="#Tier-Based-Compaction" class="headerlink" title="Tier-Based Compaction"></a>Tier-Based Compaction</h3><p>这种方案会根据候选文件的新老程度将其分为多个不同的等级，每个等级都有对应等级的参数，比如参数 Compation Ratio，表示该等级文件选择时的选择几率，Ratio 越大，该等级的文件越有可能被选中参与 Compaction。而等级数、每个等级参数都可以通过 CF 属性在线更新。</p>
<blockquote>
<p>符合冷热数据区分明显的场景。</p>
</blockquote>
<h3 id="Level-Compaction"><a href="#Level-Compaction" class="headerlink" title="Level Compaction"></a>Level Compaction</h3><p>level compaction 设计思路是将 store 中的所有数据划分为很多层，每一层都会有一部分数据，如下图所示：</p>
<p><img src="http://hbasefly.com/wp-content/uploads/2016/07/3-1.png" alt=""></p>
<ul>
<li><p>数据按照keyrange划分</p>
</li>
<li><p>数据逐层触发下沉，先写第一层，第一层写满了，再往下合并。</p>
</li>
<li><p>keyRange不重合，区分明显，要设置合理，防止不均匀。</p>
</li>
</ul>
<blockquote>
<p>这种 compaction 因为 level 层数太多导致 compaction 的次数明显增多，经过测试，发现这种 compaction 并没有对 IO 利用率有任何提升。</p>
</blockquote>
<h3 id="Stripe-Compaction"><a href="#Stripe-Compaction" class="headerlink" title="Stripe Compaction"></a>Stripe Compaction</h3><p>stripe compaction 会将整个 store 中的文件按照 Key 划分为多个 Range，在这里称为 stripe，stripe 的数量可以通过参数设定，相邻的 stripe 之间 key 不会重合。实际上在概念上来看这个 stripe 类似于 sub-region 的概念，即将一个大 region 切分成了很多小的 sub-region。</p>
<p><img src="http://hbasefly.com/wp-content/uploads/2016/07/4-1.png" alt=""></p>
<p>下面是两种 stripe compaction 比较擅长的业务场景：</p>
<ol>
<li><p>大 Region。小 region 没有必要切分为 stripes，一旦切分，反而会带来额外的管理开销。一般默认如果 region 大小小于 2G，就不适合使用 stripe compaction。</p>
</li>
<li><p>RowKey 具有统一格式，stripe compaction 要求所有数据按照 Key 进行切分，切分为多个 stripe。如果 rowkey 不具有统一格式的话，无法进行切分。</p>
</li>
</ol>
<h2 id="问题"><a href="#问题" class="headerlink" title="问题"></a>问题</h2><p>即使是这样，hbase的合并还是有问题。原因如下：</p>
<ol>
<li>正常请求下，compaction 尤其是 major compaction 会将大量数据文件合并为一个大 HFile，读出所有数据文件的 KVs，然后重新排序之后写入另一个新建的文件。如果待合并文件都在本地，那么读就是本地读，不会出现垮网络的情况。但是因为数据文件都是三副本，因此写的时候就会垮网络执行，必然会消耗带宽资源。</li>
<li>原因 1 的前提是所有待合并文件都在本地的情况，那在有些场景下待合并文件有可能并不全在本地，即本地化率没有达到 100%，比如执行过 balance 之后就会有很多文件并不在本地。这种情况下读文件的时候就会垮网络读，如果是 major compaction，必然也会大量消耗带宽资源。</li>
</ol>

                
            </div>
            <hr/>

            

    <div class="reprint" id="reprint-statement">
        
            <div class="reprint__author">
                <span class="reprint-meta" style="font-weight: bold;">
                    <i class="fas fa-user">
                        Author:
                    </i>
                </span>
                <span class="reprint-info">
                    <a href="/about" rel="external nofollow noreferrer">zhiqiang.lou</a>
                </span>
            </div>
            <div class="reprint__type">
                <span class="reprint-meta" style="font-weight: bold;">
                    <i class="fas fa-link">
                        Link:
                    </i>
                </span>
                <span class="reprint-info">
                    <a href="https://github.com/louzhiqiang/louzhiqiang.github.io.git/2022/06/28/hbase%E5%8E%9F%E7%90%86-%E7%AC%AC%E4%BA%8C%E7%AF%87/">https://github.com/louzhiqiang/louzhiqiang.github.io.git/2022/06/28/hbase%E5%8E%9F%E7%90%86-%E7%AC%AC%E4%BA%8C%E7%AF%87/</a>
                </span>
            </div>
            <div class="reprint__notice">
                <span class="reprint-meta" style="font-weight: bold;">
                    <i class="fas fa-copyright">
                        Reprint policy:
                    </i>
                </span>
                <span class="reprint-info">
                    All articles in this blog are used except for special statements
                    <a href="https://creativecommons.org/licenses/by/4.0/deed.zh" rel="external nofollow noreferrer" target="_blank">CC BY 4.0</a>
                    reprint policy. If reproduced, please indicate source
                    <a href="/about" target="_blank">zhiqiang.lou</a>
                    !
                </span>
            </div>
        
    </div>

    <script async defer>
      document.addEventListener("copy", function (e) {
        let toastHTML = '<span>Copied successfully, please follow the reprint policy of this article</span><button class="btn-flat toast-action" onclick="navToReprintStatement()" style="font-size: smaller">more</a>';
        M.toast({html: toastHTML})
      });

      function navToReprintStatement() {
        $("html, body").animate({scrollTop: $("#reprint-statement").offset().top - 80}, 800);
      }
    </script>



            <div class="tag_share" style="display: block;">
                <div class="post-meta__tag-list" style="display: inline-block;">
                    
                        <div class="article-tag">
                            
                                <a href="/tags/hbase/">
                                    <span class="chip bg-color">hbase</span>
                                </a>
                            
                        </div>
                    
                </div>
                <div class="post_share" style="zoom: 80%; width: fit-content; display: inline-block; float: right; margin: -0.15rem 0;">
                    <link rel="stylesheet" type="text/css" href="/libs/share/css/share.min.css">
<div id="article-share">

    
    <div class="social-share" data-sites="twitter,facebook,google,qq,qzone,wechat,weibo,douban,linkedin" data-wechat-qrcode-helper="<p>微信扫一扫即可分享！</p>"></div>
    <script src="/libs/share/js/social-share.min.js"></script>
    

    

</div>

                </div>
            </div>
            
                <div id="reward">
    <a href="#rewardModal" class="reward-link modal-trigger btn-floating btn-medium waves-effect waves-light red">赏</a>

    <!-- Modal Structure -->
    <div id="rewardModal" class="modal">
        <div class="modal-content">
            <a class="close modal-close"><i class="fas fa-times"></i></a>
            <h4 class="reward-title">你的赏识是我前进的动力</h4>
            <div class="reward-content">
                <div class="reward-tabs">
                    <ul class="tabs row">
                        <li class="tab col s6 alipay-tab waves-effect waves-light"><a href="#alipay">支付宝</a></li>
                        <li class="tab col s6 wechat-tab waves-effect waves-light"><a href="#wechat">微 信</a></li>
                    </ul>
                    <div id="alipay">
                        <img src="/medias/reward/alipay.jpg" class="reward-img" alt="支付宝打赏二维码">
                    </div>
                    <div id="wechat">
                        <img src="/medias/reward/wechat.png" class="reward-img" alt="微信打赏二维码">
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
    $(function () {
        $('.tabs').tabs();
    });
</script>

            
        </div>
    </div>

    

    

    

    

    

    

    

    

    

<article id="prenext-posts" class="prev-next articles">
    <div class="row article-row">
        
        <div class="article col s12 m6" data-aos="fade-up">
            <div class="article-badge left-badge text-color">
                <i class="fas fa-chevron-left"></i>&nbsp;Previous</div>
            <div class="card">
                <a href="/2022/06/30/%E5%90%91%E9%87%8F%E5%8C%96%E6%89%A7%E8%A1%8C/">
                    <div class="card-image">
                        
                        
                        <img src="/medias/featureimages/3.jpg" class="responsive-img" alt="向量化执行">
                        
                        <span class="card-title">向量化执行</span>
                    </div>
                </a>
                <div class="card-content article-content">
                    <div class="summary block-with-text">
                        
                            
                        
                    </div>
                    <div class="publish-info">
                        <span class="publish-date">
                            <i class="far fa-clock fa-fw icon-date"></i>2022-06-30
                        </span>
                        <span class="publish-author">
                            
                            <i class="fas fa-bookmark fa-fw icon-category"></i>
                            
                            <a href="/categories/%E5%9F%BA%E7%A1%80/" class="post-category">
                                    基础
                                </a>
                            
                            
                        </span>
                    </div>
                </div>
                
            </div>
        </div>
        
        
        <div class="article col s12 m6" data-aos="fade-up">
            <div class="article-badge right-badge text-color">
                Next&nbsp;<i class="fas fa-chevron-right"></i>
            </div>
            <div class="card">
                <a href="/2022/06/26/%E9%9B%B6%E6%8B%B7%E8%B4%9D/">
                    <div class="card-image">
                        
                        
                        <img src="/medias/featureimages/20.jpg" class="responsive-img" alt="零拷贝">
                        
                        <span class="card-title">零拷贝</span>
                    </div>
                </a>
                <div class="card-content article-content">
                    <div class="summary block-with-text">
                        
                            
                        
                    </div>
                    <div class="publish-info">
                            <span class="publish-date">
                                <i class="far fa-clock fa-fw icon-date"></i>2022-06-26
                            </span>
                        <span class="publish-author">
                            
                            <i class="fas fa-bookmark fa-fw icon-category"></i>
                            
                            <a href="/categories/%E8%AE%A1%E7%AE%97%E6%9C%BA/" class="post-category">
                                    计算机
                                </a>
                            
                            
                        </span>
                    </div>
                </div>
                
                <div class="card-action article-tags">
                    
                    <a href="/tags/%E5%9F%BA%E7%A1%80/">
                        <span class="chip bg-color">基础</span>
                    </a>
                    
                </div>
                
            </div>
        </div>
        
    </div>
</article>

</div>



<!-- 代码块功能依赖 -->
<script type="text/javascript" src="/libs/codeBlock/codeBlockFuction.js"></script>



<!-- 代码语言 -->

<script type="text/javascript" src="/libs/codeBlock/codeLang.js"></script>


<!-- 代码块复制 -->

<script type="text/javascript" src="/libs/codeBlock/codeCopy.js"></script>


<!-- 代码块收缩 -->

<script type="text/javascript" src="/libs/codeBlock/codeShrink.js"></script>



    </div>
    <div id="toc-aside" class="expanded col l3 hide-on-med-and-down">
        <div class="toc-widget card" style="background-color: white;">
            <div class="toc-title"><i class="far fa-list-alt"></i>&nbsp;&nbsp;TOC</div>
            <div id="toc-content"></div>
        </div>
    </div>
</div>

<!-- TOC 悬浮按钮. -->

<div id="floating-toc-btn" class="hide-on-med-and-down">
    <a class="btn-floating btn-large bg-color">
        <i class="fas fa-list-ul"></i>
    </a>
</div>


<script src="/libs/tocbot/tocbot.min.js"></script>
<script>
    $(function () {
        tocbot.init({
            tocSelector: '#toc-content',
            contentSelector: '#articleContent',
            headingsOffset: -($(window).height() * 0.4 - 45),
            collapseDepth: Number('0'),
            headingSelector: 'h2, h3, h4'
        });

        // Set scroll toc fixed.
        let tocHeight = parseInt($(window).height() * 0.4 - 64);
        let $tocWidget = $('.toc-widget');
        $(window).scroll(function () {
            let scroll = $(window).scrollTop();
            /* add post toc fixed. */
            if (scroll > tocHeight) {
                $tocWidget.addClass('toc-fixed');
            } else {
                $tocWidget.removeClass('toc-fixed');
            }
        });

        
        /* 修复文章卡片 div 的宽度. */
        let fixPostCardWidth = function (srcId, targetId) {
            let srcDiv = $('#' + srcId);
            if (srcDiv.length === 0) {
                return;
            }

            let w = srcDiv.width();
            if (w >= 450) {
                w = w + 21;
            } else if (w >= 350 && w < 450) {
                w = w + 18;
            } else if (w >= 300 && w < 350) {
                w = w + 16;
            } else {
                w = w + 14;
            }
            $('#' + targetId).width(w);
        };

        // 切换TOC目录展开收缩的相关操作.
        const expandedClass = 'expanded';
        let $tocAside = $('#toc-aside');
        let $mainContent = $('#main-content');
        $('#floating-toc-btn .btn-floating').click(function () {
            if ($tocAside.hasClass(expandedClass)) {
                $tocAside.removeClass(expandedClass).hide();
                $mainContent.removeClass('l9');
            } else {
                $tocAside.addClass(expandedClass).show();
                $mainContent.addClass('l9');
            }
            fixPostCardWidth('artDetail', 'prenext-posts');
        });
        
    });
</script>

    

</main>




    <footer class="page-footer bg-color">
    
        <link rel="stylesheet" href="/libs/aplayer/APlayer.min.css">
<style>
    .aplayer .aplayer-lrc p {
        
        display: none;
        
        font-size: 12px;
        font-weight: 700;
        line-height: 16px !important;
    }

    .aplayer .aplayer-lrc p.aplayer-lrc-current {
        
        display: none;
        
        font-size: 15px;
        color: #42b983;
    }

    
    .aplayer.aplayer-fixed.aplayer-narrow .aplayer-body {
        left: -66px !important;
    }

    .aplayer.aplayer-fixed.aplayer-narrow .aplayer-body:hover {
        left: 0px !important;
    }

    
</style>
<div class="">
    
    <div class="row">
        <meting-js class="col l8 offset-l2 m10 offset-m1 s12"
                   server="netease"
                   type="playlist"
                   id="503838841"
                   fixed='true'
                   autoplay='false'
                   theme='#42b983'
                   loop='all'
                   order='random'
                   preload='auto'
                   volume='0.7'
                   list-folded='true'
        >
        </meting-js>
    </div>
</div>

<script src="/libs/aplayer/APlayer.min.js"></script>
<script src="/libs/aplayer/Meting.min.js"></script>

    

    <div class="container row center-align"
         style="margin-bottom: 0px !important;">
        <div class="col s12 m8 l8 copy-right">
            Copyright&nbsp;&copy;
            
                <span id="year">2019-2022</span>
            
            <a href="/about" target="_blank">zhiqiang.lou</a>
            |&nbsp;Powered by&nbsp;<a href="https://hexo.io/" target="_blank">Hexo</a>
            |&nbsp;Theme&nbsp;<a href="https://github.com/blinkfox/hexo-theme-matery" target="_blank">Matery</a>
            <br>
            
            
            
                
            
            
                <span id="busuanzi_container_site_pv">
                &nbsp;|&nbsp;<i class="far fa-eye"></i>&nbsp;Total visits:&nbsp;
                    <span id="busuanzi_value_site_pv" class="white-color"></span>
            </span>
            
            
                <span id="busuanzi_container_site_uv">
                &nbsp;|&nbsp;<i class="fas fa-users"></i>&nbsp;Total visitors:&nbsp;
                    <span id="busuanzi_value_site_uv" class="white-color"></span>
            </span>
            
            <br>

            <!-- 运行天数提醒. -->
            
            <br>
            
        </div>
        <div class="col s12 m4 l4 social-link social-statis">
    <a href="https://github.com/blinkfox" class="tooltipped" target="_blank" data-tooltip="访问我的GitHub" data-position="top" data-delay="50">
        <i class="fab fa-github"></i>
    </a>



    <a href="mailto:1181062873@qq.com" class="tooltipped" target="_blank" data-tooltip="邮件联系我" data-position="top" data-delay="50">
        <i class="fas fa-envelope-open"></i>
    </a>







    <a href="tencent://AddContact/?fromId=50&fromSubId=1&subcmd=all&uin=1181062873" class="tooltipped" target="_blank" data-tooltip="QQ联系我: 1181062873" data-position="top" data-delay="50">
        <i class="fab fa-qq"></i>
    </a>







    <a href="/atom.xml" class="tooltipped" target="_blank" data-tooltip="RSS 订阅" data-position="top" data-delay="50">
        <i class="fas fa-rss"></i>
    </a>

</div>
    </div>
</footer>

<div class="progress-bar"></div>


    <!-- 搜索遮罩框 -->
<div id="searchModal" class="modal">
    <div class="modal-content">
        <div class="search-header">
            <span class="title"><i class="fas fa-search"></i>&nbsp;&nbsp;Search</span>
            <input type="search" id="searchInput" name="s" placeholder="Please enter a search keyword"
                   class="search-input">
        </div>
        <div id="searchResult"></div>
    </div>
</div>

<script type="text/javascript">
$(function () {
    var searchFunc = function (path, search_id, content_id) {
        'use strict';
        $.ajax({
            url: path,
            dataType: "xml",
            success: function (xmlResponse) {
                // get the contents from search data
                var datas = $("entry", xmlResponse).map(function () {
                    return {
                        title: $("title", this).text(),
                        content: $("content", this).text(),
                        url: $("url", this).text()
                    };
                }).get();
                var $input = document.getElementById(search_id);
                var $resultContent = document.getElementById(content_id);
                $input.addEventListener('input', function () {
                    var str = '<ul class=\"search-result-list\">';
                    var keywords = this.value.trim().toLowerCase().split(/[\s\-]+/);
                    $resultContent.innerHTML = "";
                    if (this.value.trim().length <= 0) {
                        return;
                    }
                    // perform local searching
                    datas.forEach(function (data) {
                        var isMatch = true;
                        var data_title = data.title.trim().toLowerCase();
                        var data_content = data.content.trim().replace(/<[^>]+>/g, "").toLowerCase();
                        var data_url = data.url;
                        data_url = data_url.indexOf('/') === 0 ? data.url : '/' + data_url;
                        var index_title = -1;
                        var index_content = -1;
                        var first_occur = -1;
                        // only match artiles with not empty titles and contents
                        if (data_title !== '' && data_content !== '') {
                            keywords.forEach(function (keyword, i) {
                                index_title = data_title.indexOf(keyword);
                                index_content = data_content.indexOf(keyword);
                                if (index_title < 0 && index_content < 0) {
                                    isMatch = false;
                                } else {
                                    if (index_content < 0) {
                                        index_content = 0;
                                    }
                                    if (i === 0) {
                                        first_occur = index_content;
                                    }
                                }
                            });
                        }
                        // show search results
                        if (isMatch) {
                            str += "<li><a href='" + data_url + "' class='search-result-title'>" + data_title + "</a>";
                            var content = data.content.trim().replace(/<[^>]+>/g, "");
                            if (first_occur >= 0) {
                                // cut out 100 characters
                                var start = first_occur - 20;
                                var end = first_occur + 80;
                                if (start < 0) {
                                    start = 0;
                                }
                                if (start === 0) {
                                    end = 100;
                                }
                                if (end > content.length) {
                                    end = content.length;
                                }
                                var match_content = content.substr(start, end);
                                // highlight all keywords
                                keywords.forEach(function (keyword) {
                                    var regS = new RegExp(keyword, "gi");
                                    match_content = match_content.replace(regS, "<em class=\"search-keyword\">" + keyword + "</em>");
                                });

                                str += "<p class=\"search-result\">" + match_content + "...</p>"
                            }
                            str += "</li>";
                        }
                    });
                    str += "</ul>";
                    $resultContent.innerHTML = str;
                });
            }
        });
    };

    searchFunc('/search.xml', 'searchInput', 'searchResult');
});
</script>

    <!-- 白天和黑夜主题 -->
<div class="stars-con">
    <div id="stars"></div>
    <div id="stars2"></div>
    <div id="stars3"></div>  
</div>

<script>
    function switchNightMode() {
        $('<div class="Cuteen_DarkSky"><div class="Cuteen_DarkPlanet"></div></div>').appendTo($('body')),
        setTimeout(function () {
            $('body').hasClass('DarkMode') 
            ? ($('body').removeClass('DarkMode'), localStorage.setItem('isDark', '0'), $('#sum-moon-icon').removeClass("fa-sun").addClass('fa-moon')) 
            : ($('body').addClass('DarkMode'), localStorage.setItem('isDark', '1'), $('#sum-moon-icon').addClass("fa-sun").removeClass('fa-moon')),
            
            setTimeout(function () {
            $('.Cuteen_DarkSky').fadeOut(1e3, function () {
                $(this).remove()
            })
            }, 2e3)
        })
    }
</script>

    <!-- 回到顶部按钮 -->
<div id="backTop" class="top-scroll">
    <a class="btn-floating btn-large waves-effect waves-light" href="#!">
        <i class="fas fa-arrow-up"></i>
    </a>
</div>


    <script src="/libs/materialize/materialize.min.js"></script>
    <script src="/libs/masonry/masonry.pkgd.min.js"></script>
    <script src="/libs/aos/aos.js"></script>
    <script src="/libs/scrollprogress/scrollProgress.min.js"></script>
    <script src="/libs/lightGallery/js/lightgallery-all.min.js"></script>
    <script src="/js/matery.js"></script>

    

    

    <!-- 雪花特效 -->
    

    <!-- 鼠标星星特效 -->
    

     
        <script src="https://ssl.captcha.qq.com/TCaptcha.js"></script>
        <script src="/libs/others/TencentCaptcha.js"></script>
        <button id="TencentCaptcha" data-appid="xxxxxxxxxx" data-cbfn="callback" type="button" hidden></button>
    

    <!-- Baidu Analytics -->

    <!-- Baidu Push -->

<script>
    (function () {
        var bp = document.createElement('script');
        var curProtocol = window.location.protocol.split(':')[0];
        if (curProtocol === 'https') {
            bp.src = 'https://zz.bdstatic.com/linksubmit/push.js';
        } else {
            bp.src = 'http://push.zhanzhang.baidu.com/push.js';
        }
        var s = document.getElementsByTagName("script")[0];
        s.parentNode.insertBefore(bp, s);
    })();
</script>

    
    <script src="/libs/others/clicklove.js" async="async"></script>
    
    
    <script async src="/libs/others/busuanzi.pure.mini.js"></script>
    

    

    

    <!--腾讯兔小巢-->
    
    

    

    

    
    <script src="/libs/instantpage/instantpage.js" type="module"></script>
    

</body>

</html>
